function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function _construct(t,e,r){return(_construct=isNativeReflectConstruct()?Reflect.construct:function(t,e,r){var n=[null];n.push.apply(n,e);var s=new(Function.bind.apply(t,n));return r&&_setPrototypeOf(s,r.prototype),s}).apply(null,arguments)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _possibleConstructorReturn(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?_assertThisInitialized(t):e}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _get(t,e,r){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,r){var n=_superPropBase(t,e);if(n){var s=Object.getOwnPropertyDescriptor(n,e);return s.get?s.get.call(r):s.value}})(t,e,r||t)}function set(t,e,r,n){return(set="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(t,e,r,n){var s,o=_superPropBase(t,e);if(o){if((s=Object.getOwnPropertyDescriptor(o,e)).set)return s.set.call(n,r),!0;if(!s.writable)return!1}if(s=Object.getOwnPropertyDescriptor(n,e)){if(!s.writable)return!1;s.value=r,Object.defineProperty(n,e,s)}else _defineProperty(n,e,r);return!0})(t,e,r,n)}function _set(t,e,r,n,s){if(!set(t,e,r,n||t)&&s)throw new Error("failed to set property");return r}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_nonIterableSpread()}function _arrayWithoutHoles(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}function _iterableToArray(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}import{objectToStringMap,stringMapToObject,ComparableEnum,NodeInstructionUrlHelperMixin,NodeMetadataUrlHelperMixin,UserUrlHelperMixin,NodeUrlHelperMixin,UrlHelper,Environment,AuthorizationV2Builder}from"solarnetwork-api-core";var SshCommand=function(){function t(e,r){_classCallCheck(this,t),this.command=e,this.data=r,this.constructor===t&&Object.freeze(this)}return _createClass(t,[{key:"toJsonEncoding",value:function(){var t={};this.command&&(t.cmd=this.command);var e=this.data;if(e&&e.toJsonEncoding){var r=e.toJsonEncoding();t.data=JSON.parse(r)}else e&&(t.data=e);return JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(e,r){var n,s;if(e){var o=JSON.parse(e);n=o.cmd,(s=o.data)&&r&&(s=r(JSON.stringify(s)))}return new t(n,s)}}]),t}(),SshTerminalSettings=function(){function t(e,r,n,s,o,i){_classCallCheck(this,t),this.cols=e||80,this.lines=r||24,this.width=n||640,this.height=s||480,this.type=o||"xterm",this.environment=i instanceof Map?i:objectToStringMap(i)}return _createClass(t,[{key:"toJsonEncoding",value:function(){var t={};return this.type&&(t.term=this.type),this.cols&&(t.cols=this.cols),this.lines&&(t.lines=this.lines),this.width&&(t.width=this.width),this.height&&(t.height=this.height),this.environment instanceof Map&&this.environment.size>0&&(t.environment=stringMapToObject(this.environment)),JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(e){var r=new t;if(e){var n=JSON.parse(e);n.term&&(r.type=n.term),n.cols&&(r.cols=n.cols),n.lines&&(r.lines=n.lines),n.width&&(r.width=n.width),n.height&&(r.height=n.height),n.environment&&(r.environment=objectToStringMap(n.environment))}return r}}]),t}(),SolarSshCommandAttachSsh="attach-ssh",AttachSshCommand=function(t){function e(t,r,n,s,o){_classCallCheck(this,e);var i={};if(i.authorization=t,i["authorization-date"]=r instanceof Date?r.getTime():r,i.username=n,i.password=s,o instanceof SshTerminalSettings)for(var a=JSON.parse(o.toJsonEncoding()),u=0,l=Object.keys(a);u<l.length;u++){var h=l[u];void 0===i[h]&&(i[h]=a[h])}return _possibleConstructorReturn(this,_getPrototypeOf(e).call(this,SolarSshCommandAttachSsh,i))}return _inherits(e,SshCommand),e}(),SshCloseCode=function(t){function e(t,r){var n;return _classCallCheck(this,e),(n=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t,r))).constructor===e&&Object.freeze(_assertThisInitialized(n)),n}return _inherits(e,ComparableEnum),_createClass(e,null,[{key:"enumValues",value:function(){return SshCloseCodeValues}}]),e}(),SshCloseCodeValues=Object.freeze([new SshCloseCode("AUTHENTICATION_FAILURE",4e3)]),SshCloseCodes=SshCloseCode.enumsValue(SshCloseCodeValues),SshSession=function(){function t(e,r,n,s,o,i,a,u){_classCallCheck(this,t),this.created=e,this.sessionId=r,this.nodeId=n,this.sshHost=s,this.sshPort=o,this.reverseSshPort=i,this.startInstructionId=a,this.stopInstructionId=u,this.constructor===t&&Object.freeze(this)}return _createClass(t,[{key:"toJsonEncoding",value:function(){var t={};return this.sessionId&&(t.sessionId=this.sessionId),this.created&&(t.created=this.created.getTime()),this.nodeId&&(t.nodeId=this.nodeId),this.sshHost&&(t.host=this.sshHost),this.sshPort&&(t.port=this.sshPort),this.reverseSshPort&&(t.reversePort=this.reverseSshPort),this.startInstructionId&&(t.startInstructionId=this.startInstructionId),this.stopInstructionId&&(t.stopInstructionId=this.stopInstructionId),JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(e){var r=[];if(e){var n="string"==typeof e?JSON.parse(e):e;n.created?r.push(new Date(n.created)):r.push(new Date),r.push(n.sessionId||""),r.push(n.nodeId||null),r.push(n.host||""),r.push(n.port||null),r.push(n.reversePort||null),r.push(n.startInstructionId),r.push(n.stopInstructionId)}return _construct(t,r)}}]),t}(),SolarSshDefaultPath="",SolarSshPathKey="solarSshPath",SolarSshApiPathV1="/api/v1",SolarSshTerminalWebSocketPath="/ssh",SolarSshTerminalWebSocketSubProtocol="solarssh",SshSessionKey="sshSession",StartRemoteSshInstructionName="StartRemoteSsh",StopRemoteSshInstructionName="StopRemoteSsh",InstructionUrlHelper=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,NodeInstructionUrlHelperMixin(NodeMetadataUrlHelperMixin(UserUrlHelperMixin(NodeUrlHelperMixin(UrlHelper))))),e}(),SshUrlHelperMixin=function(t){return function(e){function r(){for(var t,e,n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];_classCallCheck(this,r);var i=s&&s[0]?s[0]instanceof Environment?s[0]:new Environment(s[0]):new Environment({tls:!0,host:"ssh.solarnetwork.net",port:8443,solarSshPath:""});return s||(s=[]),s[0]=i,e=_possibleConstructorReturn(this,(t=_getPrototypeOf(r)).call.apply(t,[this].concat(_toConsumableArray(s)))),e._instructionUrlHelper=new InstructionUrlHelper,e._instructionAuthBuilder=new AuthorizationV2Builder(null,e._instructionUrlHelper),e}return _inherits(r,t),_createClass(r,[{key:"baseUrl",value:function(){var t=this.env(SolarSshPathKey)||SolarSshDefaultPath;return this.hostUrl()+t+SolarSshApiPathV1}},{key:"terminalWebSocketUrl",value:function(t){var e=this.env(SolarSshPathKey)||SolarSshDefaultPath,r=t||this.sshSessionId;return this.hostWebSocketUrl()+e+SolarSshTerminalWebSocketPath+"?sessionId="+encodeURIComponent(r)}},{key:"httpProxyUrl",value:function(t){var e=this.env(SolarSshPathKey)||SolarSshDefaultPath,r=t||this.sshSessionId;return this.hostUrl()+e+"/nodeproxy/"+encodeURIComponent(r)+"/"}},{key:"createSshSessionUrl",value:function(t){var e=t||this.nodeId;return this.baseUrl()+"/ssh/session/new?nodeId="+e}},{key:"createSshSessionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).method("GET").url(this._instructionUrlHelper.viewPendingInstructionsUrl(t))}},{key:"startSshSessionUrl",value:function(t){var e=t||this.sshSessionId;return this.baseUrl()+"/ssh/session/"+encodeURIComponent(e)+"/start"}},{key:"startSshSessionAuthBuilder",value:function(t,e){var r=t||this.sshSession||{};return this._instructionAuthBuilder.reset().snDate(!0).method("POST").contentType("application/x-www-form-urlencoded").url(this._instructionUrlHelper.queueInstructionUrl(StartRemoteSshInstructionName,[{name:"host",value:r.sshHost},{name:"user",value:r.sessionId},{name:"port",value:r.sshPort},{name:"rport",value:r.reverseSshPort}],e))}},{key:"stopSshSessionUrl",value:function(t){var e=t||this.sshSessionId;return this.baseUrl()+"/ssh/session/"+encodeURIComponent(e)+"/stop"}},{key:"stopSshSessionAuthBuilder",value:function(t,e){var r=t||this.sshSession||{},n=e||this.nodeId;return this._instructionAuthBuilder.reset().snDate(!0).method("POST").contentType("application/x-www-form-urlencoded").url(this._instructionUrlHelper.queueInstructionUrl(StopRemoteSshInstructionName,[{name:"host",value:r.sshHost},{name:"user",value:r.sessionId},{name:"port",value:r.sshPort},{name:"rport",value:r.reverseSshPort}],n))}},{key:"viewStartRemoteSshInstructionUrl",value:function(t){var e=this.sshSession||{},r=t||e.startInstructionId;return this._instructionUrlHelper.viewInstructionUrl(r)}},{key:"viewStartRemoteSshInstructionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).url(this.viewStartRemoteSshInstructionUrl(t))}},{key:"viewStopRemoteSshInstructionUrl",value:function(t){var e=this.sshSession||{},r=t||e.stopInstructionId;return this._instructionUrlHelper.viewInstructionUrl(r)}},{key:"viewStopRemoteSshInstructionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).url(this.viewStopRemoteSshInstructionUrl(t))}},{key:"connectTerminalWebSocketAuthBuilder",value:function(t){var e=t||this.nodeId;return this._instructionAuthBuilder.reset().snDate(!0).method("GET").url(this._instructionUrlHelper.viewNodeMetadataUrl(e))}},{key:"sshSession",get:function(){return this.parameter(SshSessionKey)},set:function(t){this.parameter(SshSessionKey,t)}},{key:"nodeId",set:function(t){_set(_getPrototypeOf(r.prototype),"nodeId",t,this,!0),this._instructionUrlHelper.nodeId=t},get:function(){return _get(_getPrototypeOf(r.prototype),"nodeId",this)}},{key:"nodeUrlHelperEnvironment",get:function(){return this._instructionUrlHelper.environment},set:function(t){this._instructionUrlHelper.environment=t,this._instructionAuthBuilder.environment=t}},{key:"nodeInstructionAuthBuilder",get:function(){return this._instructionAuthBuilder}},{key:"sshSessionId",get:function(){var t=this.sshSession;return t?t.sessionId:void 0}}]),r}()},SshUrlHelper=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,_getPrototypeOf(e).apply(this,arguments))}return _inherits(e,SshUrlHelperMixin(NodeUrlHelperMixin(UrlHelper))),e}();export{AttachSshCommand,SolarSshApiPathV1,SolarSshDefaultPath,SolarSshPathKey,SolarSshTerminalWebSocketPath,SolarSshTerminalWebSocketSubProtocol,SshCloseCode,SshCloseCodes,SshCommand,SshSession,SshSessionKey,SshTerminalSettings,SshUrlHelper,SshUrlHelperMixin,StartRemoteSshInstructionName,StopRemoteSshInstructionName};