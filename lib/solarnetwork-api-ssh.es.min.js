import{AuthorizationV2Builder,ComparableEnum,Environment,NodeInstructionUrlHelperMixin,NodeMetadataUrlHelperMixin,NodeUrlHelperMixin,UrlHelper,UserUrlHelperMixin,objectToStringMap,stringMapToObject}from"solarnetwork-api-core";var classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var s=0;s<e.length;s++){var n=e[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,s,n){return s&&t(e.prototype,s),n&&t(e,n),e}}(),get=function t(e,s,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,s);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,s,n)}if("value"in r)return r.value;var i=r.get;if(void 0!==i)return i.call(n)},inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},set=function t(e,s,n,r){var o=Object.getOwnPropertyDescriptor(e,s);if(void 0===o){var i=Object.getPrototypeOf(e);null!==i&&t(i,s,n,r)}else if("value"in o&&o.writable)o.value=n;else{var a=o.set;void 0!==a&&a.call(r,n)}return n},toConsumableArray=function(t){if(Array.isArray(t)){for(var e=0,s=Array(t.length);e<t.length;e++)s[e]=t[e];return s}return Array.from(t)},SshCommand=function(){function t(e,s){classCallCheck(this,t),this.command=e,this.data=s,this.constructor===t&&Object.freeze(this)}return createClass(t,[{key:"toJsonEncoding",value:function(){var t={};this.command&&(t.cmd=this.command);var e=this.data;if(e&&e.toJsonEncoding){var s=e.toJsonEncoding();t.data=JSON.parse(s)}else e&&(t.data=e);return JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(e,s){var n=void 0,r=void 0;if(e){var o=JSON.parse(e);n=o.cmd,(r=o.data)&&s&&(r=s(JSON.stringify(r)))}return new t(n,r)}}]),t}(),SshTerminalSettings=function(){function t(e,s,n,r,o,i){classCallCheck(this,t),this.cols=e||80,this.lines=s||24,this.width=n||640,this.height=r||480,this.type=o||"xterm",this.environment=i instanceof Map?i:objectToStringMap(i)}return createClass(t,[{key:"toJsonEncoding",value:function(){var t={};return this.type&&(t.term=this.type),this.cols&&(t.cols=this.cols),this.lines&&(t.lines=this.lines),this.width&&(t.width=this.width),this.height&&(t.height=this.height),this.environment instanceof Map&&this.environment.size>0&&(t.environment=stringMapToObject(this.environment)),JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(e){var s=new t;if(e){var n=JSON.parse(e);n.term&&(s.type=n.term),n.cols&&(s.cols=n.cols),n.lines&&(s.lines=n.lines),n.width&&(s.width=n.width),n.height&&(s.height=n.height),n.environment&&(s.environment=objectToStringMap(n.environment))}return s}}]),t}(),SolarSshCommandAttachSsh="attach-ssh",AttachSshCommand=function(t){function e(t,s,n,r,o){classCallCheck(this,e);var i={};if(i.authorization=t,i["authorization-date"]=s instanceof Date?s.getTime():s,i.username=n,i.password=r,o instanceof SshTerminalSettings){var a=JSON.parse(o.toJsonEncoding()),h=!0,l=!1,u=void 0;try{for(var c,p=Object.keys(a)[Symbol.iterator]();!(h=(c=p.next()).done);h=!0){var S=c.value;void 0===i[S]&&(i[S]=a[S])}}catch(t){l=!0,u=t}finally{try{!h&&p.return&&p.return()}finally{if(l)throw u}}}return possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,SolarSshCommandAttachSsh,i))}return inherits(e,SshCommand),e}(),SshCloseCode=function(t){function e(t,s){classCallCheck(this,e);var n=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,s));return n.constructor===e&&Object.freeze(n),n}return inherits(e,ComparableEnum),createClass(e,null,[{key:"enumValues",value:function(){return SshCloseCodeValues}}]),e}(),SshCloseCodeValues=Object.freeze([new SshCloseCode("AUTHENTICATION_FAILURE",4e3)]),SshCloseCodes=SshCloseCode.enumsValue(SshCloseCodeValues),SshSession=function(){function t(e,s,n,r,o,i,a,h){classCallCheck(this,t),this.created=e,this.sessionId=s,this.nodeId=n,this.sshHost=r,this.sshPort=o,this.reverseSshPort=i,this.startInstructionId=a,this.stopInstructionId=h,this.constructor===t&&Object.freeze(this)}return createClass(t,[{key:"toJsonEncoding",value:function(){var t={};return this.sessionId&&(t.sessionId=this.sessionId),this.created&&(t.created=this.created.getTime()),this.nodeId&&(t.nodeId=this.nodeId),this.sshHost&&(t.host=this.sshHost),this.sshPort&&(t.port=this.sshPort),this.reverseSshPort&&(t.reversePort=this.reverseSshPort),this.startInstructionId&&(t.startInstructionId=this.startInstructionId),this.stopInstructionId&&(t.stopInstructionId=this.stopInstructionId),JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(e){var s=[];if(e){var n="string"==typeof e?JSON.parse(e):e;n.created?s.push(new Date(n.created)):s.push(new Date),s.push(n.sessionId||""),s.push(n.nodeId||null),s.push(n.host||""),s.push(n.port||null),s.push(n.reversePort||null),s.push(n.startInstructionId),s.push(n.stopInstructionId)}return new(Function.prototype.bind.apply(t,[null].concat(s)))}}]),t}(),SolarSshDefaultPath="",SolarSshPathKey="solarSshPath",SolarSshApiPathV1="/api/v1",SolarSshTerminalWebSocketPath="/ssh",SolarSshTerminalWebSocketSubProtocol="solarssh",SshSessionKey="sshSession",StartRemoteSshInstructionName="StartRemoteSsh",StopRemoteSshInstructionName="StopRemoteSsh",InstructionUrlHelper=function(t){function e(){return classCallCheck(this,e),possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return inherits(e,t),e}(NodeInstructionUrlHelperMixin(NodeMetadataUrlHelperMixin(UserUrlHelperMixin(NodeUrlHelperMixin(UrlHelper))))),SshUrlHelperMixin=function(t){return function(e){function s(){for(var t,e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];classCallCheck(this,s);var o=n&&n[0]?n[0]instanceof Environment?n[0]:new Environment(n[0]):new Environment({tls:!0,host:"ssh.solarnetwork.net",port:8443,solarSshPath:""});n||(n=[]),n[0]=o;var i=possibleConstructorReturn(this,(t=s.__proto__||Object.getPrototypeOf(s)).call.apply(t,[this].concat(toConsumableArray(n))));return i._instructionUrlHelper=new InstructionUrlHelper,i._instructionAuthBuilder=new AuthorizationV2Builder(null,i._instructionUrlHelper),i}return inherits(s,t),createClass(s,[{key:"baseUrl",value:function(){var t=this.env(SolarSshPathKey)||SolarSshDefaultPath;return this.hostUrl()+t+SolarSshApiPathV1}},{key:"terminalWebSocketUrl",value:function(t){var e=this.env(SolarSshPathKey)||SolarSshDefaultPath,s=t||this.sshSessionId;return this.hostWebSocketUrl()+e+SolarSshTerminalWebSocketPath+"?sessionId="+encodeURIComponent(s)}},{key:"httpProxyUrl",value:function(t){var e=this.env(SolarSshPathKey)||SolarSshDefaultPath,s=t||this.sshSessionId;return this.hostUrl()+e+"/nodeproxy/"+encodeURIComponent(s)+"/"}},{key:"createSshSessionUrl",value:function(t){var e=t||this.nodeId;return this.baseUrl()+"/ssh/session/new?nodeId="+e}},{key:"createSshSessionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).method("GET").url(this._instructionUrlHelper.viewPendingInstructionsUrl(t))}},{key:"startSshSessionUrl",value:function(t){var e=t||this.sshSessionId;return this.baseUrl()+"/ssh/session/"+encodeURIComponent(e)+"/start"}},{key:"startSshSessionAuthBuilder",value:function(t,e){var s=t||this.sshSession||{};return this._instructionAuthBuilder.reset().snDate(!0).method("POST").contentType("application/x-www-form-urlencoded").url(this._instructionUrlHelper.queueInstructionUrl(StartRemoteSshInstructionName,[{name:"host",value:s.sshHost},{name:"user",value:s.sessionId},{name:"port",value:s.sshPort},{name:"rport",value:s.reverseSshPort}],e))}},{key:"stopSshSessionUrl",value:function(t){var e=t||this.sshSessionId;return this.baseUrl()+"/ssh/session/"+encodeURIComponent(e)+"/stop"}},{key:"stopSshSessionAuthBuilder",value:function(t,e){var s=t||this.sshSession||{},n=e||this.nodeId;return this._instructionAuthBuilder.reset().snDate(!0).method("POST").contentType("application/x-www-form-urlencoded").url(this._instructionUrlHelper.queueInstructionUrl(StopRemoteSshInstructionName,[{name:"host",value:s.sshHost},{name:"user",value:s.sessionId},{name:"port",value:s.sshPort},{name:"rport",value:s.reverseSshPort}],n))}},{key:"viewStartRemoteSshInstructionUrl",value:function(t){var e=this.sshSession||{},s=t||e.startInstructionId;return this._instructionUrlHelper.viewInstructionUrl(s)}},{key:"viewStartRemoteSshInstructionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).url(this.viewStartRemoteSshInstructionUrl(t))}},{key:"viewStopRemoteSshInstructionUrl",value:function(t){var e=this.sshSession||{},s=t||e.stopInstructionId;return this._instructionUrlHelper.viewInstructionUrl(s)}},{key:"viewStopRemoteSshInstructionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).url(this.viewStopRemoteSshInstructionUrl(t))}},{key:"connectTerminalWebSocketAuthBuilder",value:function(t){var e=t||this.nodeId;return this._instructionAuthBuilder.reset().snDate(!0).method("GET").url(this._instructionUrlHelper.viewNodeMetadataUrl(e))}},{key:"sshSession",get:function(){return this.parameter(SshSessionKey)},set:function(t){this.parameter(SshSessionKey,t)}},{key:"nodeId",set:function(t){set(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"nodeId",t,this),this._instructionUrlHelper.nodeId=t},get:function(){return get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"nodeId",this)}},{key:"nodeUrlHelperEnvironment",get:function(){return this._instructionUrlHelper.environment},set:function(t){this._instructionUrlHelper.environment=t,this._instructionAuthBuilder.environment=t}},{key:"nodeInstructionAuthBuilder",get:function(){return this._instructionAuthBuilder}},{key:"sshSessionId",get:function(){var t=this.sshSession;return t?t.sessionId:void 0}}]),s}()},SshUrlHelper=function(t){function e(){return classCallCheck(this,e),possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return inherits(e,t),e}(SshUrlHelperMixin(NodeUrlHelperMixin(UrlHelper)));export{AttachSshCommand,SshCloseCodes,SshCloseCode,SshCommand,SshSession,SshTerminalSettings,SshUrlHelperMixin,SolarSshDefaultPath,SolarSshPathKey,SolarSshApiPathV1,SolarSshTerminalWebSocketPath,SolarSshTerminalWebSocketSubProtocol,StartRemoteSshInstructionName,StopRemoteSshInstructionName,SshSessionKey,SshUrlHelper};