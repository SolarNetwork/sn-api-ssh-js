!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("solarnetwork-api-core")):"function"==typeof define&&define.amd?define(["exports","solarnetwork-api-core"],e):(t=t||self,e(t.sn={},t.sn))}(this,function(t,e){"use strict";function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function s(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&h(t,e)}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function h(t,e){return(h=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function a(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}function c(t,e,n){return(c=a()?Reflect.construct:function(t,e,n){var r=[null];r.push.apply(r,e);var s=new(Function.bind.apply(t,r));return n&&h(s,n.prototype),s}).apply(null,arguments)}function l(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function f(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?l(t):e}function p(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=u(t)););return t}function d(t,e,n){return(d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=p(t,e);if(r){var s=Object.getOwnPropertyDescriptor(r,e);return s.get?s.get.call(n):s.value}})(t,e,n||t)}function v(t,e,n,r){return(v="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(t,e,n,r){var s,o=p(t,e);if(o){if((s=Object.getOwnPropertyDescriptor(o,e)).set)return s.set.call(r,n),!0;if(!s.writable)return!1}if(s=Object.getOwnPropertyDescriptor(r,e)){if(!s.writable)return!1;s.value=n,Object.defineProperty(r,e,s)}else i(r,e,n);return!0})(t,e,n,r)}function S(t,e,n,r,s){if(!v(t,e,n,r||t)&&s)throw new Error("failed to set property");return n}function y(t){return m(t)||I(t)||w()}function m(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}function I(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}function w(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var b=function(){function t(e,r){n(this,t),this.command=e,this.data=r,this.constructor===t&&Object.freeze(this)}return s(t,[{key:"toJsonEncoding",value:function(){var t={};this.command&&(t.cmd=this.command);var e=this.data;if(e&&e.toJsonEncoding){var n=e.toJsonEncoding();t.data=JSON.parse(n)}else e&&(t.data=e);return JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(e,n){var r,s;if(e){var i=JSON.parse(e);r=i.cmd,(s=i.data)&&n&&(s=n(JSON.stringify(s)))}return new t(r,s)}}]),t}(),g=function(){function t(r,s,i,o,u,h){n(this,t),this.cols=r||80,this.lines=s||24,this.width=i||640,this.height=o||480,this.type=u||"xterm",this.environment=h instanceof Map?h:e.objectToStringMap(h)}return s(t,[{key:"toJsonEncoding",value:function(){var t={};return this.type&&(t.term=this.type),this.cols&&(t.cols=this.cols),this.lines&&(t.lines=this.lines),this.width&&(t.width=this.width),this.height&&(t.height=this.height),this.environment instanceof Map&&this.environment.size>0&&(t.environment=e.stringMapToObject(this.environment)),JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(n){var r=new t;if(n){var s=JSON.parse(n);s.term&&(r.type=s.term),s.cols&&(r.cols=s.cols),s.lines&&(r.lines=s.lines),s.width&&(r.width=s.width),s.height&&(r.height=s.height),s.environment&&(r.environment=e.objectToStringMap(s.environment))}return r}}]),t}(),U="attach-ssh",O=function(t){function e(t,r,s,i,o){n(this,e);var h={};if(h.authorization=t,h["authorization-date"]=r instanceof Date?r.getTime():r,h.username=s,h.password=i,o instanceof g)for(var a=JSON.parse(o.toJsonEncoding()),c=0,l=Object.keys(a);c<l.length;c++){var p=l[c];void 0===h[p]&&(h[p]=a[p])}return f(this,u(e).call(this,U,h))}return o(e,b),e}(),P=function(t){function r(t,e){var s;return n(this,r),(s=f(this,u(r).call(this,t,e))).constructor===r&&Object.freeze(l(s)),s}return o(r,e.ComparableEnum),s(r,null,[{key:"enumValues",value:function(){return k}}]),r}(),k=Object.freeze([new P("AUTHENTICATION_FAILURE",4e3)]),_=P.enumsValue(k),R=function(){function t(e,r,s,i,o,u,h,a){n(this,t),this.created=e,this.sessionId=r,this.nodeId=s,this.sshHost=i,this.sshPort=o,this.reverseSshPort=u,this.startInstructionId=h,this.stopInstructionId=a,this.constructor===t&&Object.freeze(this)}return s(t,[{key:"toJsonEncoding",value:function(){var t={};return this.sessionId&&(t.sessionId=this.sessionId),this.created&&(t.created=this.created.getTime()),this.nodeId&&(t.nodeId=this.nodeId),this.sshHost&&(t.host=this.sshHost),this.sshPort&&(t.port=this.sshPort),this.reverseSshPort&&(t.reversePort=this.reverseSshPort),this.startInstructionId&&(t.startInstructionId=this.startInstructionId),this.stopInstructionId&&(t.stopInstructionId=this.stopInstructionId),JSON.stringify(t)}}],[{key:"fromJsonEncoding",value:function(e){var n=[];if(e){var r="string"==typeof e?JSON.parse(e):e;r.created?n.push(new Date(r.created)):n.push(new Date),n.push(r.sessionId||""),n.push(r.nodeId||null),n.push(r.host||""),n.push(r.port||null),n.push(r.reversePort||null),n.push(r.startInstructionId),n.push(r.stopInstructionId)}return c(t,n)}}]),t}(),A=function(t){function r(){return n(this,r),f(this,u(r).apply(this,arguments))}return o(r,e.NodeInstructionUrlHelperMixin(e.NodeMetadataUrlHelperMixin(e.UserUrlHelperMixin(e.NodeUrlHelperMixin(e.UrlHelper))))),r}(),H=function(t){return function(r){function i(){for(var t,r,s=arguments.length,o=new Array(s),h=0;h<s;h++)o[h]=arguments[h];n(this,i);var a=o&&o[0]?o[0]instanceof e.Environment?o[0]:new e.Environment(o[0]):new e.Environment({tls:!0,host:"ssh.solarnetwork.net",port:8443,solarSshPath:""});return o||(o=[]),o[0]=a,r=f(this,(t=u(i)).call.apply(t,[this].concat(y(o)))),r._instructionUrlHelper=new A,r._instructionAuthBuilder=new e.AuthorizationV2Builder(null,r._instructionUrlHelper),r}return o(i,t),s(i,[{key:"baseUrl",value:function(){var t=this.env("solarSshPath")||"";return this.hostUrl()+t+"/api/v1"}},{key:"terminalWebSocketUrl",value:function(t){var e=this.env("solarSshPath")||"",n=t||this.sshSessionId;return this.hostWebSocketUrl()+e+"/ssh?sessionId="+encodeURIComponent(n)}},{key:"httpProxyUrl",value:function(t){var e=this.env("solarSshPath")||"",n=t||this.sshSessionId;return this.hostUrl()+e+"/nodeproxy/"+encodeURIComponent(n)+"/"}},{key:"createSshSessionUrl",value:function(t){var e=t||this.nodeId;return this.baseUrl()+"/ssh/session/new?nodeId="+e}},{key:"createSshSessionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).method("GET").url(this._instructionUrlHelper.viewPendingInstructionsUrl(t))}},{key:"startSshSessionUrl",value:function(t){var e=t||this.sshSessionId;return this.baseUrl()+"/ssh/session/"+encodeURIComponent(e)+"/start"}},{key:"startSshSessionAuthBuilder",value:function(t,e){var n=t||this.sshSession||{};return this._instructionAuthBuilder.reset().snDate(!0).method("POST").contentType("application/x-www-form-urlencoded").url(this._instructionUrlHelper.queueInstructionUrl("StartRemoteSsh",[{name:"host",value:n.sshHost},{name:"user",value:n.sessionId},{name:"port",value:n.sshPort},{name:"rport",value:n.reverseSshPort}],e))}},{key:"stopSshSessionUrl",value:function(t){var e=t||this.sshSessionId;return this.baseUrl()+"/ssh/session/"+encodeURIComponent(e)+"/stop"}},{key:"stopSshSessionAuthBuilder",value:function(t,e){var n=t||this.sshSession||{},r=e||this.nodeId;return this._instructionAuthBuilder.reset().snDate(!0).method("POST").contentType("application/x-www-form-urlencoded").url(this._instructionUrlHelper.queueInstructionUrl("StopRemoteSsh",[{name:"host",value:n.sshHost},{name:"user",value:n.sessionId},{name:"port",value:n.sshPort},{name:"rport",value:n.reverseSshPort}],r))}},{key:"viewStartRemoteSshInstructionUrl",value:function(t){var e=this.sshSession||{},n=t||e.startInstructionId;return this._instructionUrlHelper.viewInstructionUrl(n)}},{key:"viewStartRemoteSshInstructionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).url(this.viewStartRemoteSshInstructionUrl(t))}},{key:"viewStopRemoteSshInstructionUrl",value:function(t){var e=this.sshSession||{},n=t||e.stopInstructionId;return this._instructionUrlHelper.viewInstructionUrl(n)}},{key:"viewStopRemoteSshInstructionAuthBuilder",value:function(t){return this._instructionAuthBuilder.reset().snDate(!0).url(this.viewStopRemoteSshInstructionUrl(t))}},{key:"connectTerminalWebSocketAuthBuilder",value:function(t){var e=t||this.nodeId;return this._instructionAuthBuilder.reset().snDate(!0).method("GET").url(this._instructionUrlHelper.viewNodeMetadataUrl(e))}},{key:"sshSession",get:function(){return this.parameter("sshSession")},set:function(t){this.parameter("sshSession",t)}},{key:"nodeId",set:function(t){S(u(i.prototype),"nodeId",t,this,!0),this._instructionUrlHelper.nodeId=t},get:function(){return d(u(i.prototype),"nodeId",this)}},{key:"nodeUrlHelperEnvironment",get:function(){return this._instructionUrlHelper.environment},set:function(t){this._instructionUrlHelper.environment=t,this._instructionAuthBuilder.environment=t}},{key:"nodeInstructionAuthBuilder",get:function(){return this._instructionAuthBuilder}},{key:"sshSessionId",get:function(){var t=this.sshSession;return t?t.sessionId:void 0}}]),i}()},j=function(t){function r(){return n(this,r),f(this,u(r).apply(this,arguments))}return o(r,H(e.NodeUrlHelperMixin(e.UrlHelper))),r}();t.AttachSshCommand=O,t.SolarSshApiPathV1="/api/v1",t.SolarSshDefaultPath="",t.SolarSshPathKey="solarSshPath",t.SolarSshTerminalWebSocketPath="/ssh",t.SolarSshTerminalWebSocketSubProtocol="solarssh",t.SshCloseCode=P,t.SshCloseCodes=_,t.SshCommand=b,t.SshSession=R,t.SshSessionKey="sshSession",t.SshTerminalSettings=g,t.SshUrlHelper=j,t.SshUrlHelperMixin=H,t.StartRemoteSshInstructionName="StartRemoteSsh",t.StopRemoteSshInstructionName="StopRemoteSsh",Object.defineProperty(t,"__esModule",{value:!0})});